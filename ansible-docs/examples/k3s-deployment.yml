---
# K3s Cluster Deployment Playbook
# Installs and configures K3s server and agents

- name: Setup K3s master node
  hosts: k3s_master
  become: yes
  tags:
    - k3s
    - master
  roles:
    - k3s_master

- name: Setup K3s worker nodes
  hosts: k3s_workers
  become: yes
  tags:
    - k3s
    - workers
  roles:
    - k3s_worker

- name: Verify cluster health
  hosts: k3s_master
  become: yes
  tags:
    - k3s
    - verify
  tasks:
    - name: Wait for all nodes to be ready
      ansible.builtin.command: kubectl wait --for=condition=Ready nodes --all --timeout=300s
      register: nodes_ready
      changed_when: false

    - name: Get cluster status
      ansible.builtin.command: kubectl get nodes -o wide
      register: cluster_status
      changed_when: false

    - name: Display cluster status
      ansible.builtin.debug:
        msg: "{{ cluster_status.stdout_lines }}"

    - name: Check system pods
      ansible.builtin.command: kubectl get pods -n kube-system
      register: system_pods
      changed_when: false

    - name: Display system pods
      ansible.builtin.debug:
        msg: "{{ system_pods.stdout_lines }}"
